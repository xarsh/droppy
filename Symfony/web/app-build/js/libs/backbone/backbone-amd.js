//     (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

(function(e,t){typeof exports!="undefined"?t(e,exports,require("jQuery")):typeof define=="function"&&define.amd?define(["Underscore","jQuery","exports"],function(n,r,i){e.Backbone=t(e,i,n,r)}):e.Backbone=t(e,{},e._,e.jQuery||e.Zepto||e.ender)})(this,function(e,t,n,r){var i=e.Backbone,s=Array.prototype.slice,o=Array.prototype.splice;t.VERSION="0.9.2",t.setDomLibrary=function(e){r=e},t.noConflict=function(){return e.Backbone=i,t},t.emulateHTTP=!1,t.emulateJSON=!1;var u=/\s+/,a=t.Events={on:function(e,t,n){var r,i,s,o,a;if(!t)return this;e=e.split(u),r=this._callbacks||(this._callbacks={});while(i=e.shift())a=r[i],s=a?a.tail:{},s.next=o={},s.context=n,s.callback=t,r[i]={tail:o,next:a?a.next:s};return this},off:function(e,t,r){var i,s,o,a,f,l;if(!(s=this._callbacks))return;if(!(e||t||r))return delete this._callbacks,this;e=e?e.split(u):n.keys(s);while(i=e.shift()){o=s[i],delete s[i];if(!o||!t&&!r)continue;a=o.tail;while((o=o.next)!==a)f=o.callback,l=o.context,(t&&f!==t||r&&l!==r)&&this.on(i,f,l)}return this},trigger:function(e){var t,n,r,i,o,a,f;if(!(r=this._callbacks))return this;a=r.all,e=e.split(u),f=s.call(arguments,1);while(t=e.shift()){if(n=r[t]){i=n.tail;while((n=n.next)!==i)n.callback.apply(n.context||this,f)}if(n=a){i=n.tail,o=[t].concat(f);while((n=n.next)!==i)n.callback.apply(n.context||this,o)}}return this}};a.bind=a.on,a.unbind=a.off;var f=t.Model=function(e,t){var r;e||(e={}),t&&t.parse&&(e=this.parse(e));if(r=C(this,"defaults"))e=n.extend({},r,e);t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=n.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=n.clone(this.attributes),this.initialize.apply(this,arguments)};n.extend(f.prototype,a,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return n.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var r=this.get(e);return this._escapedAttributes[e]=n.escape(r==null?"":""+r)},has:function(e){return this.get(e)!=null},set:function(e,t,r){var i,s,o;n.isObject(e)||e==null?(i=e,r=t):(i={},i[e]=t),r||(r={});if(!i)return this;i instanceof f&&(i=i.attributes);if(r.unset)for(s in i)i[s]=void 0;if(!this._validate(i,r))return!1;this.idAttribute in i&&(this.id=i[this.idAttribute]);var u=r.changes={},a=this.attributes,l=this._escapedAttributes,c=this._previousAttributes||{};for(s in i){o=i[s];if(!n.isEqual(a[s],o)||r.unset&&n.has(a,s))delete l[s],(r.silent?this._silent:u)[s]=!0;r.unset?delete a[s]:a[s]=o,!n.isEqual(c[s],o)||n.has(a,s)!=n.has(c,s)?(this.changed[s]=o,r.silent||(this._pending[s]=!0)):(delete this.changed[s],delete this._pending[s])}return r.silent||this.change(r),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(n.clone(this.attributes),e)},fetch:function(e){e=e?n.clone(e):{};var r=this,i=e.success;return e.success=function(t,n,s){if(!r.set(r.parse(t,s),e))return!1;i&&i(r,t)},e.error=t.wrapError(e.error,r,e),(this.sync||t.sync).call(this,"read",this,e)},save:function(e,r,i){var s,o;n.isObject(e)||e==null?(s=e,i=r):(s={},s[e]=r),i=i?n.clone(i):{};if(i.wait){if(!this._validate(s,i))return!1;o=n.clone(this.attributes)}var u=n.extend({},i,{silent:!0});if(s&&!this.set(s,i.wait?u:i))return!1;var a=this,f=i.success;i.success=function(e,t,r){var o=a.parse(e,r);i.wait&&(delete i.wait,o=n.extend(s||{},o));if(!a.set(o,i))return!1;f?f(a,e):a.trigger("sync",a,e,i)},i.error=t.wrapError(i.error,a,i);var l=this.isNew()?"create":"update",c=(this.sync||t.sync).call(this,l,this,i);return i.wait&&this.set(o,u),c},destroy:function(e){e=e?n.clone(e):{};var r=this,i=e.success,s=function(){r.trigger("destroy",r,r.collection,e)};if(this.isNew())return s(),!1;e.success=function(t){e.wait&&s(),i?i(r,t):r.trigger("sync",r,t,e)},e.error=t.wrapError(e.error,r,e);var o=(this.sync||t.sync).call(this,"delete",this,e);return e.wait||s(),o},url:function(){var e=C(this,"urlRoot")||C(this.collection,"url")||k();return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var r in this._silent)this._pending[r]=!0;var i=n.extend({},e.changes,this._silent);this._silent={};for(var r in i)this.trigger("change:"+r,this,this.get(r),e);if(t)return this;while(!n.isEmpty(this._pending)){this._pending={},this.trigger("change",this,e);for(var r in this.changed){if(this._pending[r]||this._silent[r])continue;delete this.changed[r]}this._previousAttributes=n.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return arguments.length?n.has(this.changed,e):!n.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?n.clone(this.changed):!1;var t,r=!1,i=this._previousAttributes;for(var s in e){if(n.isEqual(i[s],t=e[s]))continue;(r||(r={}))[s]=t}return r},previous:function(e){return!arguments.length||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return n.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=n.extend({},this.attributes,e);var r=this.validate(e,t);return r?(t&&t.error?t.error(this,r,t):this.trigger("error",this,r,t),!1):!0}});var l=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};n.extend(l.prototype,a,{model:f,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var r,i,s,u,a,f,l={},c={},h=[];t||(t={}),e=n.isArray(e)?e.slice():[e];for(r=0,s=e.length;r<s;r++){if(!(u=e[r]=this._prepareModel(e[r],t)))throw new Error("Can't add an invalid model to a collection");a=u.cid,f=u.id;if(l[a]||this._byCid[a]||f!=null&&(c[f]||this._byId[f])){h.push(r);continue}l[a]=c[f]=u}r=h.length;while(r--)e.splice(h[r],1);for(r=0,s=e.length;r<s;r++)(u=e[r]).on("all",this._onModelEvent,this),this._byCid[u.cid]=u,u.id!=null&&(this._byId[u.id]=u);this.length+=s,i=t.at!=null?t.at:this.models.length,o.apply(this.models,[i,0].concat(e)),this.comparator&&this.sort({silent:!0});if(t.silent)return this;for(r=0,s=this.models.length;r<s;r++){if(!l[(u=this.models[r]).cid])continue;t.index=r,u.trigger("add",u,this,t)}return this},remove:function(e,t){var r,i,s,o;t||(t={}),e=n.isArray(e)?e.slice():[e];for(r=0,i=e.length;r<i;r++){o=this.getByCid(e[r])||this.get(e[r]);if(!o)continue;delete this._byId[o.id],delete this._byCid[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,t.silent||(t.index=s,o.trigger("remove",o,this,t)),this._removeReference(o)}return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,n.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return n.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){e||(e={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=n.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return n.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var r=0,i=this.models.length;r<i;r++)this._removeReference(this.models[r]);return this._reset(),this.add(e,n.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?n.clone(e):{},e.parse===undefined&&(e.parse=!0);var r=this,i=e.success;return e.success=function(t,n,s){r[e.add?"add":"reset"](r.parse(t,s),e),i&&i(r,t)},e.error=t.wrapError(e.error,r,e),(this.sync||t.sync).call(this,"read",this,e)},create:function(e,t){var r=this;t=t?n.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||r.add(e,t);var i=t.success;return t.success=function(n,s,o){t.wait&&r.add(n,t),i?i(n,s):n.trigger("sync",e,s,t)},e.save(null,t),e},parse:function(e,t){return e},chain:function(){return n(this.models).chain()},_reset:function(e){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){t||(t={});if(e instanceof f)e.collection||(e.collection=this);else{var n=e;t.collection=this,e=new this.model(n,t),e._validate(e.attributes,t)||(e=!1)}return e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments)}});var c=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];n.each(c,function(e){l.prototype[e]=function(){return n[e].apply(n,[this.models].concat(n.toArray(arguments)))}});var h=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},p=/:\w+/g,d=/\*\w+/g,v=/[-[\]{}()+?.,\\^$|#\s]/g;n.extend(h.prototype,a,{initialize:function(){},route:function(e,r,i){return t.history||(t.history=new m),n.isRegExp(e)||(e=this._routeToRegExp(e)),i||(i=this[r]),t.history.route(e,n.bind(function(n){var s=this._extractParameters(e,n);i&&i.apply(this,s),this.trigger.apply(this,["route:"+r].concat(s)),t.history.trigger("route",this,r,s)},this)),this},navigate:function(e,n){t.history.navigate(e,n)},_bindRoutes:function(){if(!this.routes)return;var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var n=0,r=e.length;n<r;n++)this.route(e[n][0],e[n][1],this[e[n][1]])},_routeToRegExp:function(e){return e=e.replace(v,"\\$&").replace(p,"([^/]+)").replace(d,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var m=t.History=function(){this.handlers=[],n.bindAll(this,"checkUrl")},g=/^[#\/]/,y=/msie [\w.]+/;m.started=!1,n.extend(m.prototype,a,{interval:50,getHash:function(e){var t=e?e.location:window.location,n=t.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||t){e=window.location.pathname;var n=window.location.search;n&&(e+=n)}else e=this.getHash();return e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(g,"")},start:function(e){if(m.started)throw new Error("Backbone.history has already been started");m.started=!0,this.options=n.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),i=document.documentMode,s=y.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);s&&(this.iframe=r('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?r(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?r(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var o=window.location,u=o.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!u)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&u&&o.hash&&(this.fragment=this.getHash().replace(g,""),window.history.replaceState({},document.title,o.protocol+"//"+o.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){r(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),m.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t==this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),r=n.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return r},navigate:function(e,t){if(!m.started)return!1;if(!t||t===!0)t={trigger:t};var n=(e||"").replace(g,"");if(this.fragment==n)return;this._hasPushState?(n.indexOf(this.options.root)!=0&&(n=this.options.root+n),this.fragment=n,window.history[t.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var b=t.View=function(e){this.cid=n.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,E=["model","collection","el","id","attributes","className","tagName"];n.extend(b.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){var i=document.createElement(e);return t&&r(i).attr(t),n!=null&&r(i).html(n),i},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof r?e:r(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=C(this,"events")))return;this.undelegateEvents();for(var t in e){var r=e[t];n.isFunction(r)||(r=this[e[t]]);if(!r)throw new Error('Method "'+e[t]+'" does not exist');var i=t.match(w),s=i[1],o=i[2];r=n.bind(r,this),s+=".delegateEvents"+this.cid,o===""?this.$el.bind(s,r):this.$el.delegate(o,s,r)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=n.extend({},this.options,e));for(var t=0,r=E.length;t<r;t++){var i=E[t];e[i]&&(this[i]=e[i])}this.options=e},_ensureElement:function(){if(!this.el){var e=C(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}else this.setElement(this.el,!1)}});var S=function(e,t){var n=N(this,e,t);return n.extend=this.extend,n};f.extend=l.extend=h.extend=b.extend=S;var x={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};t.sync=function(e,i,s){var o=x[e];s||(s={});var u={type:o,dataType:"json"};return s.url||(u.url=C(i,"url")||k()),!s.data&&i&&(e=="create"||e=="update")&&(u.contentType="application/json",u.data=JSON.stringify(i.toJSON())),t.emulateJSON&&(u.contentType="application/x-www-form-urlencoded",u.data=u.data?{model:u.data}:{}),t.emulateHTTP&&(o==="PUT"||o==="DELETE")&&(t.emulateJSON&&(u.data._method=o),u.type="POST",u.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",o)}),u.type!=="GET"&&!t.emulateJSON&&(u.processData=!1),r.ajax(n.extend(u,s))},t.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var T=function(){},N=function(e,t,r){var i;return t&&t.hasOwnProperty("constructor")?i=t.constructor:i=function(){e.apply(this,arguments)},n.extend(i,e),T.prototype=e.prototype,i.prototype=new T,t&&n.extend(i.prototype,t),r&&n.extend(i,r),i.prototype.constructor=i,i.__super__=e.prototype,i},C=function(e,t){return!e||!e[t]?null:n.isFunction(e[t])?e[t]():e[t]},k=function(){throw new Error('A "url" property or function must be specified')},L=function(e,t){var n,r,i;typeof window=="undefined"?i=module.exports=r:(n=window._,r=window.Backbone,i=window),r=t,n=e,r.Relational={showWarnings:!0},r.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(this._permitsUsed===0)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},r.BlockingQueue=function(){this._queue=[]},n.extend(r.BlockingQueue.prototype,r.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){while(this._queue&&this._queue.length)this._queue.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),r.Relational.eventQueue=new r.BlockingQueue,r.Store=function(){this._collections=[],this._reverseRelations=[],this._subModels=[],this._modelScopes=[i]},n.extend(r.Store.prototype,r.Events,{addModelScope:function(e){this._modelScopes.push(e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){n.find(this._subModels,function(t){return n.find(t.subModels,function(n,r){var i=this.getObjectByName(n);if(e===i)return t.superModelType._subModels[r]=e,e._superModel=t.superModelType,e._subModelTypeValue=r,e._subModelTypeAttribute=t.superModelType.prototype.subModelTypeAttribute,!0},this)},this)},addReverseRelation:function(e){var t=n.any(this._reverseRelations,function(t){return n.all(e,function(e,n){return e===t[n]})});if(!t&&e.model&&e.type){this._reverseRelations.push(e);var r=function(e,t){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(t),n.each(e._subModels,function(e){r(e,t)},this)};r(e.model,e),this.retroFitRelation(e)}},retroFitRelation:function(e){var t=this.getCollection(e.model);t.each(function(t){if(!(t instanceof e.model))return;new e.type(t,e)},this)},getCollection:function(e){e instanceof r.RelationalModel&&(e=e.constructor);var t=e;while(t._superModel)t=t._superModel;var i=n.detect(this._collections,function(e){return e.model===t});return i||(i=this._createCollection(e)),i},getObjectByName:function(e){var t=e.split("."),r=null;return n.find(this._modelScopes,function(e){r=n.reduce(t,function(e,t){return e[t]},e);if(r&&r!==e)return!0},this),r},_createCollection:function(e){var t;return e instanceof r.RelationalModel&&(e=e.constructor),e.prototype instanceof r.RelationalModel&&(t=new r.Collection,t.model=e,this._collections.push(t)),t},resolveIdForItem:function(e,t){var i=n.isString(t)||n.isNumber(t)?t:null;return i==null&&(t instanceof r.RelationalModel?i=t.id:n.isObject(t)&&(i=t[e.prototype.idAttribute])),i},find:function(e,t){var n=this.resolveIdForItem(e,t),r=this.getCollection(e);if(r){var i=r.get(n);if(i instanceof e)return i}return null},register:function(e){var t=e.collection,n=this.getCollection(e);n&&n.add(e),e.bind("destroy",this.unregister,this),e.collection=t},update:function(e){var t=this.getCollection(e);t._onModelEvent("change:"+e.idAttribute,e,t)},unregister:function(e){e.unbind("destroy",this.unregister);var t=this.getCollection(e);t&&t.remove(e)}}),r.Relational.store=new r.Store,r.Relation=function(e,t){this.instance=e,t=n.isObject(t)?t:{},this.reverseRelation=n.defaults(t.reverseRelation||{},this.options.reverseRelation),this.reverseRelation.type=n.isString(this.reverseRelation.type)?r[this.reverseRelation.type]||r.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.model=t.model||this.instance.constructor,this.options=n.defaults(t,this.options,r.Relation.prototype.options),this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.relatedModel=this.options.relatedModel,n.isString(this.relatedModel)&&(this.relatedModel=r.Relational.store.getObjectByName(this.relatedModel));if(!this.checkPreconditions())return!1;e&&(this.keyContents=this.instance.get(this.keySource),this.key!==this.keySource&&this.instance.unset(this.keySource,{silent:!0}),this.instance._relations.push(this)),!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&r.Relational.store.addReverseRelation(n.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),n.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved"),e&&(this.initialize(),r.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection),r.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved))},r.Relation.extend=r.Model.extend,n.extend(r.Relation.prototype,r.Events,r.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(e,t,n){var r=this;e.queue(function(){r.tryAddRelated(e,n)})},_relatedModelRemoved:function(e,t,n){this.removeRelated(e,n)},_modelRemovedFromCollection:function(e){e===this.instance&&this.destroy()},checkPreconditions:function(){var e=this.instance,t=this.key,i=this.model,s=this.relatedModel,o=r.Relational.showWarnings&&typeof console!="undefined";if(!i||!t||!s)return o&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,i,t,s),!1;if(i.prototype instanceof r.RelationalModel){if(s.prototype instanceof r.RelationalModel){if(this instanceof r.HasMany&&this.reverseRelation.type===r.HasMany)return o&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&e._relations.length){var u=n.any(e._relations,function(e){var n=this.reverseRelation.key&&e.reverseRelation.key;return e.relatedModel===s&&e.key===t&&(!n||this.reverseRelation.key===e.reverseRelation.key)},this);if(u)return o&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,e,t,s,this.reverseRelation.key),!1}return!0}return o&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,s),!1}return o&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,e),!1},setRelated:function(e,t){this.related=e,this.instance.acquire(),this.instance.set(this.key,e,n.defaults(t||{},{silent:!0})),this.instance.release()},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key?!0:!1},getReverseRelations:function(e){var t=[],r=n.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e];return n.each(r,function(e){n.each(e.getRelations(),function(e){this._isReverseRelation(e)&&t.push(e)},this)},this),t},sanitizeOptions:function(e){return e=e?n.clone(e):{},e.silent&&(e.silentChange=!0,delete e.silent),e},unsanitizeOptions:function(e){return e=e?n.clone(e):{},e.silentChange&&(e.silent=!0,delete e.silentChange),e},destroy:function(){r.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection),r.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved),n.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),r.HasOne=r.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){n.bindAll(this,"onChange"),this.instance.bind("relational:change:"+this.key,this.onChange);var e=this.findRelated({silent:!0});this.setRelated(e),n.each(this.getReverseRelations(),function(e){e.addRelated(this.instance)},this)},findRelated:function(e){var t=this.keyContents,n=null;return t instanceof this.relatedModel?n=t:t&&(n=this.relatedModel.findOrCreate(t,{create:this.options.createModels})),n},onChange:function(e,t,i){if(this.isLocked())return;this.acquire(),i=this.sanitizeOptions(i);var s=n.isUndefined(i._related),o=s?this.related:i._related;if(s){this.keyContents=t;if(t instanceof this.relatedModel)this.related=t;else if(t){var u=this.findRelated(i);this.setRelated(u)}else this.setRelated(null)}o&&this.related!==o&&n.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,i)},this),n.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);if(!i.silentChange&&this.related!==o){var a=this;r.Relational.eventQueue.add(function(){a.instance.trigger("update:"+a.key,a.instance,a.related,i)})}this.release()},tryAddRelated:function(e,t){if(this.related)return;t=this.sanitizeOptions(t);var n=this.keyContents;if(n){var i=r.Relational.store.resolveIdForItem(this.relatedModel,n);e.id===i&&this.addRelated(e,t)}},addRelated:function(e,t){if(e!==this.related){var n=this.related||null;this.setRelated(e),this.onChange(this.instance,e,{_related:n})}},removeRelated:function(e,t){if(!this.related)return;if(e===this.related){var n=this.related||null;this.setRelated(null),this.onChange(this.instance,e,{_related:n})}}}),r.HasMany=r.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:r.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(){n.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset"),this.instance.bind("relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,n.isString(this.collectionType)&&(this.collectionType=r.Relational.store.getObjectByName(this.collectionType));if(!this.collectionType.prototype instanceof r.Collection)throw new Error("collectionType must inherit from Backbone.Collection");this.keyContents instanceof r.Collection?this.setRelated(this._prepareCollection(this.keyContents)):this.setRelated(this._prepareCollection()),this.findRelated({silent:!0})},_getCollectionOptions:function(){return n.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions},_prepareCollection:function(e){this.related&&this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset);if(!e||!(e instanceof r.Collection))e=new this.collectionType([],this._getCollectionOptions());e.model=this.relatedModel;if(this.options.collectionKey){var t=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[t]&&e[t]!==this.instance?r.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,t,this.options.collectionKey):t&&(e[t]=this.instance)}return e.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset),e},findRelated:function(e){if(this.keyContents){var t=[];this.keyContents instanceof r.Collection?t=this.keyContents.models:(this.keyContents=n.isArray(this.keyContents)?this.keyContents:[this.keyContents],n.each(this.keyContents,function(e){var n=null;e instanceof this.relatedModel?n=e:n=this.relatedModel.findOrCreate(e,{create:this.options.createModels}),n&&!this.related.getByCid(n)&&!this.related.get(n)&&t.push(n)},this)),t.length&&(e=this.unsanitizeOptions(e),this.related.add(t,e))}},onChange:function(e,t,i){i=this.sanitizeOptions(i),this.keyContents=t,n.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance,i)},this);if(t instanceof r.Collection)this._prepareCollection(t),this.related=t;else{var s;this.related instanceof r.Collection?(s=this.related,s.remove(s.models)):s=this._prepareCollection(),this.setRelated(s),this.findRelated(i)}n.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);var o=this;r.Relational.eventQueue.add(function(){!i.silentChange&&o.instance.trigger("update:"+o.key,o.instance,o.related,i)})},tryAddRelated:function(e,t){t=this.sanitizeOptions(t);if(!this.related.getByCid(e)&&!this.related.get(e)){var i=n.any(this.keyContents,function(t){var n=r.Relational.store.resolveIdForItem(this.relatedModel,t);return n&&n===e.id},this);i&&this.related.add(e,t)}},handleAddition:function(e,t,i){if(!(e instanceof r.Model))return;i=this.sanitizeOptions(i),n.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var s=this;r.Relational.eventQueue.add(function(){!i.silentChange&&s.instance.trigger("add:"+s.key,e,s.related,i)})},handleRemoval:function(e,t,i){if(!(e instanceof r.Model))return;i=this.sanitizeOptions(i),n.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,i)},this);var s=this;r.Relational.eventQueue.add(function(){!i.silentChange&&s.instance.trigger("remove:"+s.key,e,s.related,i)})},handleReset:function(e,t){t=this.sanitizeOptions(t);var n=this;r.Relational.eventQueue.add(function(){!t.silentChange&&n.instance.trigger("reset:"+n.key,n.related,t)})},addRelated:function(e,t){var n=this;t=this.unsanitizeOptions(t),e.queue(function(){n.related&&!n.related.getByCid(e)&&!n.related.get(e)&&n.related.add(e,t)})},removeRelated:function(e,t){t=this.unsanitizeOptions(t),(this.related.getByCid(e)||this.related.get(e))&&this.related.remove(e,t)}}),r.RelationalModel=r.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,t){var i=this;if(t&&t.collection){this._deferProcessing=!0;var s=function(e){e===i&&(i._deferProcessing=!1,i.processQueue(),t.collection.unbind("relational:add",s))};t.collection.bind("relational:add",s),n.defer(function(){s(i)})}this._queue=new r.BlockingQueue,this._queue.block(),r.Relational.eventQueue.block(),r.Model.apply(this,arguments),r.Relational.eventQueue.unblock()},trigger:function(e){if(e.length>5&&"change"===e.substr(0,6)){var t=this,n=arguments;r.Relational.eventQueue.add(function(){r.Model.prototype.trigger.apply(t,n)})}else r.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(){this.acquire(),this._relations=[],n.each(this.relations,function(e){var t=n.isString(e.type)?r[e.type]||r.Relational.store.getObjectByName(e.type):e.type;t&&t.prototype instanceof r.Relation?new t(this,e):r.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; missing or invalid type!",e)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(e){this._isInitialized&&!this.isLocked()&&n.each(this._relations,function(t){var n=this.attributes[t.keySource]||this.attributes[t.key];t.related!==n&&this.trigger("relational:change:"+t.key,this,n,e||{})},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return n.detect(this._relations,function(t){if(t.key===e)return!0},this)},getRelations:function(){return this._relations},fetchRelated:function(e,t,i){t||(t={});var s,o=[],u=this.getRelation(e),a=u&&u.keyContents,f=a&&n.select(n.isArray(a)?a:[a],function(e){var t=r.Relational.store.resolveIdForItem(u.relatedModel,e);return t&&(i||!r.Relational.store.find(u.relatedModel,t))},this);if(f&&f.length){var l=n.map(f,function(e){var t;if(n.isObject(e))t=u.relatedModel.build(e);else{var r={};r[u.relatedModel.prototype.idAttribute]=e,t=u.relatedModel.build(r)}return t},this);u.related instanceof r.Collection&&n.isFunction(u.related.url)&&(s=u.related.url(l));if(s&&s!==u.related.url()){var c=n.defaults({error:function(){var e=arguments;n.each(l,function(n){n.trigger("destroy",n,n.collection,t),t.error&&t.error.apply(n,e)})},url:s},t,{add:!0});o=[u.related.fetch(c)]}else o=n.map(l,function(e){var r=n.defaults({error:function(){e.trigger("destroy",e,e.collection,t),t.error&&t.error.apply(e,arguments)}},t);return e.fetch(r)},this)}return o},set:function(e,t,i){r.Relational.eventQueue.block();var s;n.isObject(e)||e==null?(s=e,i=t):(s={},s[e]=t);var o=r.Model.prototype.set.apply(this,arguments);return!this._isInitialized&&!this.isLocked()?(this.constructor.initializeModelHierarchy(),r.Relational.store.register(this),this.initializeRelations()):s&&this.idAttribute in s&&r.Relational.store.update(this),s&&this.updateRelations(i),r.Relational.eventQueue.unblock(),o},unset:function(e,t){r.Relational.eventQueue.block();var n=r.Model.prototype.unset.apply(this,arguments);return this.updateRelations(t),r.Relational.eventQueue.unblock(),n},clear:function(e){r.Relational.eventQueue.block();var t=r.Model.prototype.clear.apply(this,arguments);return this.updateRelations(e),r.Relational.eventQueue.unblock(),t},change:function(e){var t=this,n=arguments;r.Relational.eventQueue.add(function(){r.Model.prototype.change.apply(t,n)})},clone:function(){var e=n.clone(this.attributes);return n.isUndefined(e[this.idAttribute])||(e[this.idAttribute]=null),n.each(this.getRelations(),function(t){delete e[t.key]}),new this.constructor(e)},toJSON:function(){if(this.isLocked())return this.id;this.acquire();var e=r.Model.prototype.toJSON.call(this);return this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in e)&&(e[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),n.each(this._relations,function(t){var i=e[t.key];if(t.options.includeInJSON===!0)i&&n.isFunction(i.toJSON)?e[t.keyDestination]=i.toJSON():e[t.keyDestination]=null;else if(n.isString(t.options.includeInJSON))i instanceof r.Collection?e[t.keyDestination]=i.pluck(t.options.includeInJSON):i instanceof r.Model?e[t.keyDestination]=i.get(t.options.includeInJSON):e[t.keyDestination]=null;else if(n.isArray(t.options.includeInJSON))if(i instanceof r.Collection){var s=[];i.each(function(e){var r={};n.each(t.options.includeInJSON,function(t){r[t]=e.get(t)}),s.push(r)}),e[t.keyDestination]=s}else if(i instanceof r.Model){var s={};n.each(t.options.includeInJSON,function(e){s[e]=i.get(e)}),e[t.keyDestination]=s}else e[t.keyDestination]=null;else delete e[t.key];t.keyDestination!==t.key&&delete e[t.key]}),this.release(),e}},{setup:function(e){this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?r.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,n.each(this.prototype.relations,function(e){e.model||(e.model=this);if(e.reverseRelation&&e.model===this){var t=!0;if(n.isString(e.relatedModel)){var i=r.Relational.store.getObjectByName(e.relatedModel);t=i&&i.prototype instanceof r.RelationalModel}var s=n.isString(e.type)?r[e.type]||r.Relational.store.getObjectByName(e.type):e.type;t&&s&&s.prototype instanceof r.Relation&&new s(null,e)}},this)},build:function(e,t){var n=this;this.initializeModelHierarchy();if(this._subModels&&this.prototype.subModelTypeAttribute in e){var r=e[this.prototype.subModelTypeAttribute],i=this._subModels[r];i&&(n=i)}return new n(e,t)},initializeModelHierarchy:function(){if(n.isUndefined(this._superModel)||n.isNull(this._superModel)){r.Relational.store.setupSuperModel(this);if(this._superModel){if(this._superModel.prototype.relations){var e=n.any(this.prototype.relations,function(e){return e.model&&e.model!==this},this);e||(this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations))}}else this._superModel=!1}this.prototype.subModelTypes&&n.keys(this.prototype.subModelTypes).length!==n.keys(this._subModels).length&&n.each(this.prototype.subModelTypes,function(e){var t=r.Relational.store.getObjectByName(e);t&&t.initializeModelHierarchy()})},findOrCreate:function(e,t){var i=r.Relational.store.find(this,e);if(n.isObject(e))if(i)i.set(e,t);else if(!t||t&&t.create!==!1)i=this.build(e,t);return i}}),n.extend(r.RelationalModel.prototype,r.Semaphore),r.Collection.prototype.__prepareModel=r.Collection.prototype._prepareModel,r.Collection.prototype._prepareModel=function(e,t){t||(t={});if(e instanceof r.Model)e.collection||(e.collection=this);else{var n=e;t.collection=this,typeof this.model.build!="undefined"?e=this.model.build(n,t):e=new this.model(n,t),e._validate(e.attributes,t)||(e=!1)}return e};var s=r.Collection.prototype.__add=r.Collection.prototype.add;r.Collection.prototype.add=function(e,t){t||(t={}),n.isArray(e)||(e=[e]);var i=[];return n.each(e,function(e){if(!(e instanceof r.Model)){var n=r.Relational.store.find(this.model,e[this.model.prototype.idAttribute]);n?(n.set(n.parse?n.parse(e):e,t),e=n):e=r.Collection.prototype._prepareModel.call(this,e,t)}e instanceof r.Model&&!this.get(e)&&!this.getByCid(e)&&i.push(e)},this),i.length&&(s.call(this,i,t),n.each(i,function(e){this.trigger("relational:add",e,this,t)},this)),this};var o=r.Collection.prototype.__remove=r.Collection.prototype.remove;r.Collection.prototype.remove=function(e,t){return t||(t={}),n.isArray(e)?e=e.slice(0):e=[e],n.each(e,function(e){e=this.getByCid(e)||this.get(e),e instanceof r.Model&&(o.call(this,e,t),this.trigger("relational:remove",e,this,t))},this),this};var u=r.Collection.prototype.__reset=r.Collection.prototype.reset;r.Collection.prototype.reset=function(e,t){return u.call(this,e,t),this.trigger("relational:reset",this,t),this};var a=r.Collection.prototype.__sort=r.Collection.prototype.sort;r.Collection.prototype.sort=function(e){return a.call(this,e),this.trigger("relational:reset",this,e),this};var f=r.Collection.prototype.__trigger=r.Collection.prototype.trigger;r.Collection.prototype.trigger=function(e){if(e==="add"||e==="remove"||e==="reset"){var t=this,n=arguments;r.Relational.eventQueue.add(function(){f.apply(t,n)})}else f.apply(this,arguments);return this},r.RelationalModel.extend=function(e,t){var n=r.Model.extend.apply(this,arguments);return n.setup(this),n}}(n,t);return L});