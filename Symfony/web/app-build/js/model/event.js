define(["jQuery","Underscore","Backbone","Sync","model/user","model/event_date_time","event_manager"],function(e,t,n,r,i,s,o){var u=n.RelationalModel.extend({relations:[{type:n.HasOne,key:"creator",relatedModel:i},{type:n.HasOne,key:"startDateTime",relatedModel:s},{type:n.HasOne,key:"endDateTime",relatedModel:s}],defaults:function(){return{name:ExposeTranslation.get("event.default_name"),startDateTime:new s}},initialize:function(){(!this.get("name")||this.get("name")===null)&&this.set("name",this.defaults().name),(!this.get("startDateTime")||this.get("startDateTime")===null)&&this.set("startDateTime",new s);if(!this.get("endDateTime")||this.get("endDateTime")===null){this.set("endDateTime",new s);var e=this.get("endDateTime").get("date");e.setHours(e.getHours()+1)}},validate:function(){},timelineCategory:function(){return this.get("startDateTime").get("date")<new Date?"today":this.get("startDateTime").timelineCategory()},setFromJSON:function(e){var t=this.parse(e);this.set(t)},compareDates:function(e){return this.get("startDateTime").isSameDate(e.get("startDateTime"))?this.get("endDateTime")&&e.get("endDateTime")&&!this.get("endDateTime").isSameDate(e.get("endDateTime"))?e.get("endDateTime").compare(this.get("endDateTime")):this.get("startDateTime").compare(e.get("startDateTime")):this.get("startDateTime").compare(e.get("startDateTime"))},parse:function(e,t){var n=Object.keysToCamelCase(e.event);return n.liked="liked"in e?e.liked:!1,n.inCalendar=e.relation!==null?e.relation.in_calendar:!1,n.isCreator=e.relation!==null?e.relation.user_is_creator:!1,n.startDateTime=s.parse(n.startDateTime),n.endDateTime=s.parse(n.endDateTime),n.dropped=e.relation!==null,n},sync:function(e,t,i){var s={create:Routing.generate("droppy_event_ajax_update_event"),read:Routing.generate("droppy_event_ajax_event_and_rel",{event_id:this.get("id")}),update:Routing.generate("droppy_event_ajax_update_event"),"delete":Routing.generate("droppy_event_ajax_remove_event")};i.url=s[e];if(e==="delete"){var u={event_id:this.get("id")};return o.trigger("outOfTimeline",this),o.trigger("outOfCalendar",this),r.makeRequest("delete",u,i)}if(e==="create"){var a=i.success,t=this;i.success=function(e,n,r){a&&a(e,n,r),t.notifyAdd(t)}}return n.sync(e,t,i)},notifyAdd:function(e){e=e||this,o.trigger("calendarAdd",e),e.get("endDateTime").get("date")>=Date.getToday()&&o.trigger("timelineAdd",e)},getObject:function(){return n.RelationalModel.prototype.toJSON.call(this)},inCalendar:function(e){e=e||{},t.extend(e,{url:Routing.generate("droppy_event_ajax_event_in")}),r.makeRequest("update",{event_id:this.get("id")},e),this.set("inCalendar",!0)},outOfCalendar:function(e){e=e||{},t.extend(e,{url:Routing.generate("droppy_event_ajax_event_out")}),r.makeRequest("update",{event_id:this.get("id")},e),this.set("inCalendar",!1)},toJSON:function(e){var t=this.getObject();return t.startDateTime=this.get("startDateTime").format(),t.endDateTime=this.get("endDateTime").format(),Object.keysFromCamelCase(t)},dateToString:function(){var e=this.get("startDateTime"),t=this.get("endDateTime"),n=e.getString();return e.compare(t)===0?n:(n+=" ã€œ ",e.get("date").dateEquals(t.get("date"))?n+=t.get("date").format("H:i"):n+=t.getString(e.get("date")),n)},display:function(){var e=this.getObject();return e.startDateString=this.get("startDateTime").getString(),e.endDateString=this.get("endDateTime").getString(),e.date=this.dateToString(),e},drop:function(e){e=e||{},t.extend(e,{url:Routing.generate("droppy_event_ajax_drop")}),r.makeRequest("create",{event_id:this.get("id")},e),this.set("dropped",!0),this.set("inCalendar",!0)},undrop:function(e){e=e||{},t.extend(e,{url:Routing.generate("droppy_event_ajax_undrop")}),r.makeRequest("delete",{event_id:this.get("id")},e),o.trigger("outOfTimeline",this),o.trigger("outOfCalendar",this),this.set("dropped",!1)}});return u});