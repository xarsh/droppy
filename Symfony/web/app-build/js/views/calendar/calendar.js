define(["jQuery","Underscore","Backbone","views/calendar/calendar_event","helpers/template_manager","views/calendar/event_creation_popup","collections/calendar_events","event_manager","helpers/assets"],function(e,t,n,r,i,s,o,u,a){var f=n.View.extend({template:t.template(i.getCalendarTemplate()),initialize:function(){this.date=new Date,this.calendarEvents=o,this.startListening(),this.views=[],this.thisMonthEnabled=!1,this.mouseWheelActive=!1,e("div#body").append(s.render().el)},startListening:function(){this.calendarEvents.bind("add",this.addAll,this),this.calendarEvents.bind("reset",this.addAll,this),this.calendarEvents.bind("remove",this.addAll,this),u.on("resize",this.resize,this),u.on("calendarChange",this.addAll,this),u.on("calendarUpdate",this.updateDatas,this),u.on("calendarReset",this.resetCalendar,this)},events:{"click span.calendar_button.prev":"lastMonth","click span.calendar_button.next":"nextMonth","click span.calendar_button.current":"thisMonth","mousemove table.calendar tbody":"colorCell","mouseleave table.calendar tbody":"uncolorCell","click div.calendar td":"showEventCreationPopup","mousewheel div.calendar tbody":"changeMonth"},changeMonth:function(e,t){if(this.mouseWheelActive)return;t>0?this.lastMonth():this.nextMonth(),this.mouseWheelActive=!0;var n=this;setTimeout(function(){n.mouseWheelActive=!1},200)},resize:function(){var t=e(window).height(),n=e("div#header").height(),r=this.$("div.calendar_tools").height(),i=this.$("table.calendar"),s=i.find("thead tr").height(),o=t-n-r-s,u=i.children("tbody");u.height(o);var a=u.children("tr").filter(":visible");a.height(o/a.length),this.addAll()},setDate:function(e){this.date=e},update:function(e){this.updateDatas(),this.updateView(e)},updateDatas:function(){var e=this,t=this.calendarEvents;t.setDate(this.date),this.firstDay=this.date.firstDateToDisplay(),this.lastDay=this.date.lastDateToDisplay(),u.trigger("loading"),t.fetch({add:!0,silent:!0,success:function(){e.addAll(),u.trigger("endLoading")}})},lastMonth:function(){this.date.setMonth(this.date.getMonth()-1),this.update(!0)},nextMonth:function(){this.date.setMonth(this.date.getMonth()+1),this.update(!0)},thisMonth:function(){this.thisMonthEnabled&&(this.date=new Date,this.update(!0))},updateView:function(e){this.updateButtonsView(),this.updateCalendarView(),e&&(this.date.sameMonth(new Date)?u.trigger("pageChanged","top"):u.trigger("pageChanged","calendar",{date:this.date.format("Y-m")}))},resetCalendar:function(){this.calendarEvents.reset([],{silent:!0}),this.updateDatas()},updateButtonsView:function(){var e=this.$("div.calendar_tools tr");e.find("td.date").text(this.date.format(ExposeTranslation.get("time.year_month")));var t=e.find("td.right span.current");this.date.sameMonth(new Date)?(t.addClass("disabled"),this.thisMonthEnabled=!1):(t.removeClass("disabled"),this.thisMonthEnabled=!0)},updateCalendarView:function(){var e=this.date.firstDateToDisplay(),t=this.date.daysToDisplay(),n=this.$("table.calendar tbody tr");n.hide();var r=n.first();for(var i=0;i<t/7;i++){var s=r.children("td").first();for(var o=0;o<7;o++)s.attr("id",e.format("Y-m-d")),s.attr("class",e.getClassName(this.date)),s.children("p").text(e.getDate()),s=s.next(),e.setDate(e.getDate()+1);r.show(),r=r.next()}},render:function(){return this.$el.html(this.template()),this},show:function(){this.loaded=!0,this.update(),this.$el.show()},addOne:function(e){var n=new r({model:e}),i=e.get("startDateTime").get("date");i=this.firstDay>i?new Date(this.firstDay):new Date(i);var s=e.get("endDateTime").get("date");s=this.lastDay<s?new Date(this.lastDay):new Date(s);var o={eventsAbove:this.calendarEvents.getEventsNumberOnDate(i),preceded:!i.dateEquals(e.get("startDateTime").get("date"))},u=this.$(".calendar tbody td"),a=Math.floor((u.height()-u.children("p").outerHeight(!0))/(n.height+2));if(o.eventsAbove>=a)return;o.allDay=e.get("startDateTime").get("allDay")||!i.dateEquals(s);while(i<=s){var f=Math.min(s.getDaysDifference(i),i.toLastDayOfWeek()),l=i.fromFirstDayOfWeek(),c=i.rowsFromFirstDisplayedDay(0,this.date);i.setDate(i.getDate()+f),o.followed=i<=s;var h=t.extend(this.getCellInfos(f,c,l,e.get("startDateTime").get("allDay")),o);n.display(h),o.preceded=!0}e.printed=!0,this.$("table.calendar tbody").append(n.render().el),this.views.push(n)},getCellInfos:function(e,t,n,r){var i=this.$("table.calendar tbody"),s=i.find("tr").eq(t),o=s.find("td").eq(n),u=o.offset(),a=r?1:0,f=s.find("td").eq(n+e-1),l=f.offset().left+f.innerWidth()-2*a;return{top:u.top+o.children("p").outerHeight(!0),left:u.left,width:l-u.left}},addAll:function(){for(var e in this.views)this.views[e].remove();this.view=[],this.calendarEvents.resetPrintedStatus();var t=this.calendarEvents.getEventsInMonth();for(var e=0;e<t.length;e++){var n=t[e];n.get("dropped")&&n.get("inCalendar")&&this.addOne(n)}},colorCell:function(t){this.$("td.hover").removeClass("hover");var n=this.$("table.calendar tbody").offset(),r={top:t.clientY-n.top+e(window).scrollTop(),left:t.clientX-n.left},i={height:this.$("table.calendar td").outerHeight(),width:this.$("table.calendar td").outerWidth()};numberOfCell=Math.min(Math.floor((1+r.left)/i.width),6),numberOfCell+=7*Math.floor(r.top/i.height),this.$("table.calendar").find("td").eq(numberOfCell).addClass("hover")},showEventCreationPopup:function(t){t.stopPropagation();var n=e(t.target);n.is("p")&&(n=n.parent("td")),s.setDate(n.attr("id")),s.render(),s.open(t.pageX,t.pageY),s.$("input.title").focus()},uncolorCell:function(){this.$("td.hover").removeClass("hover")}});return new f});